<div class="main-container">
  <header class="header-container">
    <div class="header-content">
      <!-- Logo Section -->
      <div class="logo-section" (click)="router.navigate(['/home'])">
        <mat-icon>article</mat-icon>
        <span>Postly</span>
      </div>

      <!-- Search Section -->
      <app-header-search />

      <!-- Navigation Section -->
      <nav class="navigation-section">
        <!-- Feed Button -->
        <button mat-button class="feed-btn" (click)="router.navigate(['/home'])">
          <mat-icon>home</mat-icon>
          <span>Feed</span>
        </button>

        <!-- Create Post Button -->
        <button mat-flat-button class="create-post-btn" (click)="router.navigate(['/new-post'])">
          <mat-icon>add_circle_outline</mat-icon>
          <span>Create Post</span>
        </button>

        <!-- Theme Toggle -->
        <button
          mat-icon-button
          class="theme-toggle"
          (click)="toggleTheme()"
          [matTooltip]="isDarkMode() ? 'Switch to Light Mode' : 'Switch to Dark Mode'"
        >
          <mat-icon>{{ isDarkMode() ? 'light_mode' : 'dark_mode' }}</mat-icon>
        </button>

        <!-- Notifications Menu -->
        <button
          mat-icon-button
          class="notification-btn"
          [matMenuTriggerFor]="notificationMenu"
          (menuOpened)="onNotificationMenuOpened()"
          matTooltip="Notifications"
        >
          <mat-icon
            [matBadge]="notificationCount"
            matBadgeColor="warn"
            [matBadgeHidden]="notificationCount === 0"
          >
            notifications
          </mat-icon>
        </button>

        <mat-menu #notificationMenu="matMenu" class="notification-menu" xPosition="before">
          <div class="menu-header" (click)="$event.stopPropagation()">
            <h3>Notifications</h3>
            <div class="menu-actions">
              <button
                mat-icon-button
                (click)="refreshNotifications()"
                matTooltip="Refresh"
                class="refresh-btn"
              >
                <mat-icon>refresh</mat-icon>
              </button>
              @if (notificationCount > 0 && notificationCount > 0) {
              <button mat-button color="primary" (click)="markAllAsRead()">Mark all as read</button>
              }
            </div>
          </div>
          <mat-divider></mat-divider>
          <div class="notification-list">
            @if (!notificationsLoaded()) {
            <div class="loading-state">
              <mat-spinner diameter="40"></mat-spinner>
              <p>Loading notifications...</p>
            </div>
            } @else if (notifications.length === 0) {
            <div class="empty-state">
              <mat-icon>notifications_none</mat-icon>
              <p>No notifications yet</p>
            </div>
            } @else {
              @for (notification of notifications; track notification.id) {
                <app-notification-item [notification]="notification"></app-notification-item>
              }

              <!-- Infinite scroll trigger -->
              @if (notificationService.hasMore()) {
                <div
                  class="infinite-scroll-trigger"
                  appInfiniteScroll
                  (scrolled)="loadMoreNotifications()">
                  @if (notificationService.loading()) {
                    <div class="loading-more">
                      <mat-spinner diameter="24"></mat-spinner>
                      <span>Loading more...</span>
                    </div>
                  }
                </div>
              }
            }
          </div>
          @if (!isSSEConnected && notificationsLoaded()) {
          <div class="connection-warning" (click)="$event.stopPropagation()">
            <mat-icon>warning</mat-icon>
            <span>Real-time updates disconnected</span>
          </div>
          }
        </mat-menu>

        <!-- Profile Menu -->
        <button
          mat-icon-button
          class="profile-btn"
          [matMenuTriggerFor]="profileMenu"
          matTooltip="Profile"
        >
          @if (currentUser?.profileUrl) {
          <img
            [src]="currentUser?.profileUrl"
            [alt]="currentUser?.username"
            class="profile-avatar"
          />
          } @else {
          <mat-icon>account_circle</mat-icon>
          }
        </button>

        <mat-menu #profileMenu="matMenu" class="profile-menu" xPosition="before">
          <button mat-menu-item (click)="navigateToProfile()">
            <mat-icon>person</mat-icon>
            <span>My Profile</span>
          </button>

          @if (isAdmin) {
          <button mat-menu-item (click)="navigateToAdminPanel()">
            <mat-icon>admin_panel_settings</mat-icon>
            <span>Admin Panel</span>
          </button>
          }

          <mat-divider></mat-divider>

          <button mat-menu-item (click)="logout()" class="logout-btn">
            <mat-icon>logout</mat-icon>
            <span>Logout</span>
          </button>
        </mat-menu>
      </nav>
    </div>
  </header>
  <div class="container">
    <main class="main-content">
      <router-outlet></router-outlet>
    </main>
  </div>
</div>
